

### 场景

我们这边做的是一个汽车中控台上的软件。底层依赖的是手百的小程序框架，具体的实现还是通过开发百度小程序。

我们这边也做了一些比较特殊的功能
1. 语音触控屏， 就是用户可以通过语音和小程序进行交互。
2. 换肤，我们的项目将来要在不能的车企上进行上线。每个车企的样式风格是不同了，所以我们为了兼容不同的车企，做了换肤的方案。
3. 自适应，车机的屏幕跟手机屏幕还是有很大不同的。


#### 语音触控屏

- 原理，给我们的组件添加了一些特定的属性，比如type和name，因为页面上有很多的交互类型，比如点击、滚动、选择之类的，type代表的是操作的类型，name代表的是具体的内容，比如支付按钮，选项1、选项2、商品列表。当页面加载后，或者页面内容有变化的时候，我便会查找含有这个特定属性的组件，这些组件也有自己的id，然后结合用户说的话，上传到服务端，由服务端解析后，返回数据，这些数据包含组件的id和对应的操作。然后我们根据id找到对应的组件，然后触发它绑定的事件。然后把对应的参数放在event上传过去。

针对低版本车机走的优化。
在项目开始的时候，小程序那边的技术人员给我们提供了一个页面发生渲染和更新后的回调，这个回调触发之后，就去递归查找这些节点信息，我们为了不太耗性能还是做了防抖处理。
但是后来在一些性能比较低的车机上发现，这个操作还是比较好性能。

主要问题：页面更新的回调太频繁。其实大部分的时候都是一些无用的信息。

比如：

- 1. 某些元素删除。
- 2. 某些元素设置了类名。
- 3. 甚至滚动的时候也会触发。

这些内容的变更，对于我们语音是无意义的，但是却产生了一些副作用。

我为了去解决这种问题，首先是过滤掉这些无用的更新，在对语义状态无意的情况下，我们不去收集节点信息。

通过使用MutationObserver 对页面进行一个监听。最主要的监听有两个。

- 1. 一个是看看有没有新增加的节点。
- 2. 通过attributeFilter: ['data-type'] 去监听对我们有意义的属性。

通过这种方式呢，我们对这个性能的优化也是比较明显的。

#### 换肤

- 我们调研过一些换肤的方案，实现的原理都是去切换css文件，但是也有一些不同。比较常见的是利用sass或者less的变量，然后在编译的阶段生成对应的几套css文件。这种方式对于我们来说有些问题，
  - 1. 这个是在编译阶阶段提前生成css文件，但是如果我们这边增加了一套皮肤，就需要重新去编译，这个不太实际。
  - 2. 小程序本身不支持dom之类的操作，也就是说开发者没有办法控制切换css文件，切换css文件只能交给底层的宿主环境去做，但是宿主又不知道开发编译的css文件在哪里。

这种方式行不通，我们就用了另一种方式就是通过css变量。使用这种方式的优势是，我们仅需要替换css变量文件就可以了。为了减少开发的成本，我们还封装了组件库。


#### 自适应

